<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de √Åudio - Thiago Castro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* BASE THEME */
        :root {
            --bg-start: #f5f5f5;
            --bg-end: #e0e0e0;
            --panel-bg: #ffffff;
            --text-color: #1f2937; 
            --subtitle-color: #f97316; 
            --input-bg: #f9fafb; 
            --input-border: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.15); 
            --header-color: #1f2937;
            --theme-toggle-color: #475569;
            --delineado-color: rgba(249, 115, 22, 0.15);
            --delineado-border: rgba(249, 115, 22, 0.3);
            --tab-text: #1f2937;
            --tab-bg: #e5e7eb;
            --tab-active-bg: #f97316;
            --tab-active-text: white;
        }

        .dark-mode {
            --bg-start: #1e1e1e; 
            --bg-end: #333333;   
            --panel-bg: #2a2a2a; 
            --text-color: #f3f4f6;
            --subtitle-color: #fb923c;
            --input-bg: #3a3a3a; 
            --input-border: #525252;
            --shadow-color: rgba(0, 0, 0, 0.9);
            --header-color: #f3f4f6;
            --theme-toggle-color: #cbd5e1;
            --delineado-color: rgba(251, 146, 60, 0.5);
            --delineado-border: var(--subtitle-color);
            --tab-text: #f3f4f6;
            --tab-bg: #1f2937;
            --tab-active-bg: #fb923c;
            --tab-active-text: #1f2937;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(160deg, var(--bg-start) 0%, var(--bg-end) 100%);
            min-height: 100vh;
            color: var(--text-color);
            transition: background 0.5s, color 0.5s;
        }

        .glass-panel {
            background: var(--panel-bg);
            border: 1px solid var(--delineado-border);
            box-shadow: 0 0 0 3px var(--delineado-color), 
                        0 15px 30px -8px var(--shadow-color);
            transition: background 0.5s, box-shadow 0.5s, border-color 0.5s;
        }

        .h1-dynamic { color: var(--header-color); }
        .p-dynamic { color: var(--text-color); }
        .p-subtitle { color: var(--subtitle-color); }
        .input-bg { 
            background-color: var(--input-bg); 
            border-color: var(--input-border);
            color: var(--text-color);
            transition: background-color 0.5s, border-color 0.5s, color 0.5s;
        }
        .theme-toggle-color { color: var(--theme-toggle-color); }

        .tab-button {
            color: var(--tab-text);
            background-color: var(--tab-bg);
        }
        .tab-button.active {
            color: var(--tab-active-text);
            background-color: var(--tab-active-bg);
            box-shadow: 0 4px 10px rgba(249, 115, 22, 0.4);
        }
        .dark-mode .tab-button.active {
            box-shadow: 0 4px 10px rgba(251, 146, 60, 0.4);
        }

        .dark-mode select { color: var(--text-color) !important; }
        .dark-mode select option { background-color: #171717; color: #f3f4f6; }
        
        @keyframes shimmer {
            0% { background-position: -400px 0; }
            100% { background-position: 400px 0; }
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center">

    <div class="w-full max-w-[32rem] glass-panel p-6 sm:p-8 md:p-10 rounded-3xl my-8 relative">
        
        <!-- Bot√£o de Modo Escuro/Claro -->
        <button id="theme-toggle" class="absolute top-4 right-4 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-black/30 transition duration-300 theme-toggle-color" onclick="toggleTheme()">
            <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75v-2.25m-6.364 1.591l1.591-1.591M3 12h2.25m-.386-6.364l1.591 1.591M12 12a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5zm0 0l-1.577 1.577c.348.069.676.108 1.006.108h1.144c.33 0 .658-.039 1.006-.108l-1.577-1.577z" />
            </svg>
            <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6 hidden">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.726 9.726 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.59.748-3.75 0 0-.482-.692-.68-1.55-.178-.795-.145-1.516.29-2.007.435-.491 1.156-.524 1.951-.346.858.198 1.55.68 1.55.68A9.757 9.757 0 0118.75 3c.795 0 1.58.077 2.338.226z" />
            </svg>
        </button>

        <div class="text-center mb-10">
            <div class="relative w-36 h-36 mx-auto mb-6 group">
                <img id="profile-image" src="https://raw.githubusercontent.com/atomicgamesbrasil/Painel-Atomic/main/texto%20em%20voz.webp?v=999" onerror="this.onerror=null; this.src='https://api.dicebear.com/9.x/avataaars/svg?seed=Thiago';" alt="Thiago Castro" class="w-full h-full rounded-full object-cover shadow-xl border-4 border-white transition-transform duration-300 transform group-hover:scale-105 bg-gray-200">
            </div>
            <h1 class="text-4xl sm:text-5xl font-extrabold h1-dynamic tracking-tight">Gerador de √Åudio</h1>
            <p class="font-extrabold text-xl mt-2 p-subtitle">Thiago Castro</p>
            <p class="mt-4 p-dynamic max-w-md mx-auto text-base leading-relaxed">Transforme seus textos em √°udio com voz natural. Otimizado para Mobile.</p>
        </div>

        <div class="flex p-1 rounded-xl shadow-inner mb-8" style="background-color: var(--input-bg);">
            <button class="flex-1 py-3 px-2 rounded-xl text-sm font-bold tab-button active" onclick="showTab('tts', this)">Texto p/ √Åudio</button>
            <button class="flex-1 py-3 px-2 rounded-xl text-sm font-bold tab-button" onclick="showTab('translate', this)">Tradu√ß√£o</button>
        </div>

        <div id="tab-content" class="space-y-8">
            <!-- TTS Tab -->
            <div id="tts" class="tab-pane">
                <div class="p-2 rounded-xl border shadow-md input-bg">
                    <div class="relative">
                        <select id="voice-select" class="w-full p-4 bg-transparent font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 appearance-none cursor-pointer input-bg">
                            <option value="Orus" selected>üéôÔ∏è Orus (Masculina - Padr√£o)</option>
                            <option value="Puck">üéôÔ∏è Puck (Masculina - Suave)</option>
                            <option value="Fenrir">üéôÔ∏è Fenrir (Masculina - Grave)</option>
                            <option value="Charon">üéôÔ∏è Charon (Masculina - Jovem)</option>
                            <option value="Iapetus">üéôÔ∏è Iapetus (Masculina - Clara)</option>
                            <option value="Kore">üéôÔ∏è Kore (Feminina - Clara)</option>
                            <option value="Leda">üéôÔ∏è Leda (Feminina - Calma)</option>
                            <option value="Aoede">üéôÔ∏è Aoede (Feminina - Elegante)</option>
                        </select>
                        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none p-dynamic">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </div>
                    </div>
                </div>

                <div>
                    <label for="text-input" class="block text-xs font-bold uppercase tracking-wider mb-2 ml-1 p-dynamic">Seu Texto</label>
                    <textarea id="text-input" rows="10" class="w-full p-6 border rounded-3xl focus:ring-2 focus:ring-orange-500 focus:border-transparent resize-y transition-shadow text-base leading-relaxed shadow-lg shadow-slate-100 input-bg" placeholder="Digite ou cole o texto aqui...">E a√≠, galera! Eu sou o Thiago Castro!
Essa √© a minha voz padr√£o, com sotaque carioca. Use este espa√ßo para testar as varia√ß√µes de voz e gerar seus √°udios.üöÄ</textarea>
                </div>

                <button id="generate-button" class="w-full group relative bg-orange-500 hover:bg-orange-600 text-white font-bold py-5 px-6 rounded-2xl shadow-xl shadow-orange-400/50 transition-all duration-300 transform hover:-translate-y-1 active:shadow-none disabled:opacity-70 disabled:cursor-not-allowed overflow-hidden" onclick="generateFullAudio()">
                    <div class="relative z-10 flex items-center justify-center gap-3">
                        <span id="button-icon">üé§</span>
                        <span id="button-text">Gerar √Åudio Completo</span>
                        <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </div>
                </button>

                <div id="progress-container" class="hidden pt-2">
                    <div class="flex justify-between text-xs font-semibold mb-2 p-dynamic">
                        <span id="progress-text">Processando...</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden input-bg">
                        <div id="progress-bar" class="bg-orange-500 h-3 rounded-full transition-all duration-300 ease-out w-0 relative overflow-hidden"><div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div></div>
                    </div>
                </div>

                <div id="results-area" class="mt-8 hidden animate-[fadeIn_0.5s_ease-out]">
                    <div class="bg-green-100 border border-green-200 rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-green-200 p-2 rounded-full text-green-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                            <h2 class="text-xl font-bold text-green-800">Pronto, Thiago!</h2>
                        </div>
                        <div class="p-4 rounded-xl shadow-md border input-bg">
                            <audio id="audio-player" controls class="w-full accent-orange-500"></audio>
                        </div>
                        <p class="text-center text-green-700/70 text-sm mt-3 font-medium p-dynamic">Clique nos tr√™s pontinhos do player para baixar o arquivo</p>
                    </div>
                </div>
                <div id="error-message" class="hidden mt-6 bg-red-100 border border-red-300 text-red-700 p-4 rounded-xl text-sm font-medium animate-[shake_0.5s_ease-in-out] shadow-md"></div>
            </div>

            <!-- Translation Tab -->
            <div id="translate" class="tab-pane hidden">
                <div class="space-y-4">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <select id="translate-source-lang" class="flex-1 p-3 rounded-xl border input-bg">
                            <option value="pt" selected>Portugu√™s (detectado)</option>
                            <option value="en">Ingl√™s</option>
                            <option value="es">Espanhol</option>
                            <option value="fr">Franc√™s</option>
                            <option value="de">Alem√£o</option>
                            <option value="it">Italiano</option>
                            <option value="ja">Japon√™s</option>
                            <option value="ko">Coreano</option>
                            <option value="zh">Chin√™s</option>
                            <option value="ru">Russo</option>
                        </select>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 my-auto p-dynamic self-center sm:self-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                        <select id="translate-target-lang" class="flex-1 p-3 rounded-xl border input-bg">
                            <option value="en" selected>Ingl√™s (EUA)</option>
                            <option value="pt">Portugu√™s</option>
                            <option value="es">Espanhol</option>
                            <option value="fr">Franc√™s</option>
                            <option value="de">Alem√£o</option>
                            <option value="it">Italiano</option>
                            <option value="ja">Japon√™s</option>
                            <option value="ko">Coreano</option>
                            <option value="zh">Chin√™s</option>
                            <option value="ru">Russo</option>
                        </select>
                    </div>
                    <label class="block text-xs font-bold uppercase tracking-wider ml-1 p-dynamic">Texto Original</label>
                    <textarea id="translation-source-text" rows="6" class="w-full p-6 border rounded-3xl resize-y shadow-lg input-bg" placeholder="Digite o texto a ser traduzido..."></textarea>
                    <button id="translate-button" class="w-full group relative bg-orange-500 hover:bg-orange-600 text-white font-bold py-5 px-6 rounded-2xl shadow-xl shadow-orange-400/50 transition-all duration-300 transform hover:-translate-y-1" onclick="translateText()">
                        <span id="translate-button-text" class="relative z-10 flex items-center justify-center gap-2">Traduzir Agora</span>
                        <svg id="translate-loading-spinner" class="animate-spin h-5 w-5 text-white absolute inset-0 m-auto hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                    <label class="block text-xs font-bold uppercase tracking-wider ml-1 p-dynamic mt-4">Resultado</label>
                    <textarea id="translation-result-text" rows="6" class="w-full p-6 border rounded-3xl resize-y shadow-lg input-bg" readonly placeholder="A tradu√ß√£o aparecer√° aqui."></textarea>
                </div>
            </div>
        </div>

        <div id="error-message" class="hidden mt-6 bg-red-100 border border-red-300 text-red-700 p-4 rounded-xl text-sm font-medium animate-[shake_0.5s_ease-in-out] shadow-md"></div>
    </div>

    <script>
        // ---------------- CONFIGURA√á√ÉO DE SEGURAN√áA ----------------
        // PASSO 1: Mantenha as 3 primeiras letras (Padr√£o Google √© "AIz")
        const KEY_PREFIX = "AIz"; 
        
        // PASSO 2: COLE AQUI O RESTANTE DA CHAVE (Sem as 3 primeiras letras)
        // A chave fornecida pelo usu√°rio foi inserida aqui:
        const PARTIAL_KEY = "-lang-client-0485496897"; 
        
        // O app reconstr√≥i a chave automaticamente
        const apiKey = KEY_PREFIX + PARTIAL_KEY;
        // -----------------------------------------------------------

        const ttsApiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent";
        const textApiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        // Valida√ß√£o simples
        function checkApiKey() {
            if (!PARTIAL_KEY || PARTIAL_KEY.length < 10) {
                alert("ERRO DE CONFIGURA√á√ÉO:\n\nVoc√™ precisa abrir o arquivo 'index.html' e colar sua Chave de API na vari√°vel PARTIAL_KEY.");
                return false;
            }
            return true;
        }

        // --- FUN√á√ïES AUXILIARES ---
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1; const bytesPerSample = 2;
            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);
            let offset = 0;
            const writeString = (s) => { for (let i = 0; i < s.length; i++) view.setUint8(offset++, s.charCodeAt(i)); };
            const writeUint32 = (i) => { view.setUint32(offset, i, true); offset += 4; };
            const writeUint16 = (i) => { view.setUint16(offset, i, true); offset += 2; };

            writeString('RIFF'); writeUint32(36 + pcm16.length * bytesPerSample); writeString('WAVE'); writeString('fmt ');
            writeUint32(16); writeUint16(1); writeUint16(numChannels); writeUint32(sampleRate);
            writeUint32(sampleRate * numChannels * bytesPerSample); writeUint16(numChannels * bytesPerSample);
            writeUint16(bytesPerSample * 8); writeString('data'); writeUint32(pcm16.length * bytesPerSample);

            for (let i = 0; i < pcm16.length; i++) { view.setInt16(offset, pcm16[i], true); offset += 2; }
            return new Blob([view], { type: 'audio/wav' });
        }

        // --- TEMA E ABAS ---
        const body = document.body;
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');

        function applyTheme(theme) {
            if (theme === 'dark') {
                body.classList.add('dark-mode');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                body.classList.remove('dark-mode');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            localStorage.setItem('theme', theme);
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            showTab('tts', document.querySelector('.tab-button'));
        });
        
        function showTab(tabId, clickedButton) {
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabId).classList.remove('hidden');
            clickedButton.classList.add('active');
        }

        // --- DIVIS√ÉO INTELIGENTE DE TEXTO ---
        function splitTextIntoSentences(text) {
            const segments = text.match(/[^.?!;]+[.?!;]*|.+/g) || [];
            let chunks = [];
            let currentChunk = "";
            for (let segment of segments) {
                if ((currentChunk + segment).length < 200) {
                    currentChunk += segment;
                } else {
                    if (currentChunk.trim().length > 0) chunks.push(currentChunk);
                    currentChunk = segment;
                }
            }
            if (currentChunk.trim().length > 0) chunks.push(currentChunk);
            return chunks;
        }

        // --- TRADU√á√ÉO ---
        async function translateText() {
            if (!checkApiKey()) return;

            const sourceTextarea = document.getElementById('translation-source-text');
            const resultTextarea = document.getElementById('translation-result-text');
            const sourceLang = document.getElementById('translate-source-lang').value;
            const targetLang = document.getElementById('translate-target-lang').value;
            const translateButton = document.getElementById('translate-button');
            const translateButtonText = document.getElementById('translate-button-text');
            const translateLoadingSpinner = document.getElementById('translate-loading-spinner');

            const text = sourceTextarea.value.trim();
            if (!text) {
                sourceTextarea.classList.add('ring-2', 'ring-red-500', 'bg-red-50');
                setTimeout(() => sourceTextarea.classList.remove('ring-2', 'ring-red-500', 'bg-red-50'), 500);
                return;
            }

            translateButton.disabled = true;
            translateButtonText.classList.add('hidden');
            translateLoadingSpinner.classList.remove('hidden');
            resultTextarea.value = "Traduzindo...";

            const userQuery = `Traduza o seguinte texto do idioma com c√≥digo '${sourceLang}' para o idioma com c√≥digo '${targetLang}'. Retorne apenas o texto traduzido e nada mais. Texto: ${text}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }] };

            try {
                let response, result;
                for (let i = 0; i < 3; i++) { 
                    response = await fetch(`${textApiUrl}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) { result = await response.json(); break; }
                    if (response.status === 429) await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                    else throw new Error(`Erro API: ${response.status}`);
                }
                
                if (!result) throw new Error("Falha na conex√£o.");
                resultTextarea.value = result.candidates?.[0]?.content?.parts?.[0]?.text || "Erro ao traduzir.";

            } catch (error) {
                console.error("Erro:", error);
                resultTextarea.value = `Erro: ${error.message}`;
            } finally {
                translateButton.disabled = false;
                translateButtonText.classList.remove('hidden');
                translateLoadingSpinner.classList.add('hidden');
            }
        }

        // --- TTS (√ÅUDIO) ---
        const textInput = document.getElementById('text-input');
        const generateButton = document.getElementById('generate-button');
        const buttonText = document.getElementById('button-text');
        const buttonIcon = document.getElementById('button-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsArea = document.getElementById('results-area');
        const audioPlayer = document.getElementById('audio-player');
        const errorMessage = document.getElementById('error-message');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressPercent = document.getElementById('progress-percent');

        async function fetchAudioChunk(textChunk, voiceName) {
            const url = `${ttsApiUrl}?key=${apiKey}`;
            const fullPrompt = `Leia em portugu√™s do Brasil, estilo carioca educado, tom informal, com ritmo ligeiramente acelerado: ${textChunk}`;
            
            const payload = {
                contents: [{ parts: [{ text: fullPrompt }] }],
                generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceName } } } }
            };

            let response, result;
            const timeoutDuration = 20000;
            
            for (let i = 0; i < 5; i++) { 
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeoutDuration);

                    response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    if (response.ok) {
                        try { result = await response.json(); } catch (e) { await new Promise(r => setTimeout(r, 1000)); continue; }
                        if (result.candidates?.[0]?.content?.parts?.[0]?.inlineData) break;
                        await new Promise(r => setTimeout(r, 1000)); continue;
                    }
                    
                    if (response.status === 429) await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                    else throw new Error(`Erro API: ${response.status}`);

                } catch (error) {
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
            
            if (!result || !result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data) {
                throw new Error("Falha na gera√ß√£o do √°udio.");
            }

            const part = result.candidates[0].content.parts[0].inlineData;
            return {
                buffer: base64ToArrayBuffer(part.data),
                sampleRate: part.mimeType.match(/rate=(\d+)/) ? parseInt(part.mimeType.match(/rate=(\d+)/)[1]) : 24000
            };
        }

        async function generateFullAudio() {
            if (!checkApiKey()) return;

            const text = textInput.value.trim();
            const selectedVoice = document.getElementById('voice-select').value;

            if (!text) {
                textInput.classList.add('ring-2', 'ring-red-500', 'bg-red-50');
                setTimeout(() => textInput.classList.remove('ring-2', 'ring-red-500', 'bg-red-50'), 500);
                return;
            }

            generateButton.disabled = true;
            buttonText.textContent = 'Gerando √Åudio...';
            buttonIcon.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            errorMessage.classList.add('hidden');
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            audioPlayer.src = '';

            try {
                const chunks = splitTextIntoSentences(text);
                const totalChunks = chunks.length;
                let allPcmData = [];
                let finalSampleRate = 24000;

                for (let i = 0; i < totalChunks; i++) {
                    const chunkText = chunks[i];
                    const percent = Math.round(((i) / totalChunks) * 100);
                    progressBar.style.width = `${percent}%`;
                    progressPercent.textContent = `${percent}%`;
                    progressText.textContent = `Processando parte ${i + 1} de ${totalChunks}...`;

                    if (i > 0) await new Promise(r => setTimeout(r, 750));

                    try {
                        const chunkAudio = await fetchAudioChunk(chunkText, selectedVoice);
                        finalSampleRate = chunkAudio.sampleRate;
                        allPcmData.push(new Int16Array(chunkAudio.buffer));
                    } catch (err) {
                        console.warn(`Pulando trecho ${i+1}:`, err);
                    }
                }

                if (allPcmData.length === 0) throw new Error("Nenhum √°udio gerado. Verifique sua chave de API.");

                progressBar.style.width = `100%`;
                progressPercent.textContent = `100%`;
                
                const totalLength = allPcmData.reduce((acc, curr) => acc + curr.length, 0);
                const finalBuffer = new Int16Array(totalLength);
                let offset = 0;
                for (const chunk of allPcmData) {
                    finalBuffer.set(chunk, offset);
                    offset += chunk.length;
                }

                const wavBlob = pcmToWav(finalBuffer, finalSampleRate);
                audioPlayer.src = URL.createObjectURL(wavBlob);
                resultsArea.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                errorMessage.textContent = `Erro: ${error.message}`;
                errorMessage.classList.remove('hidden');
            } finally {
                generateButton.disabled = false;
                buttonText.textContent = 'Gerar √Åudio Completo';
                buttonIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                setTimeout(() => { if(!resultsArea.classList.contains('hidden')) progressContainer.classList.add('hidden'); }, 1000);
            }
        }
    </script>
</body>
</html>
