<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de √Åudio - Thiago Castro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* BASE THEME */
        :root {
            --bg-start: #f5f5f5;
            --bg-end: #e0e0e0;
            --panel-bg: #ffffff;
            --text-color: #1f2937; 
            --subtitle-color: #f97316; 
            --input-bg: #f9fafb; 
            --input-border: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.15); 
            --header-color: #1f2937;
            --theme-toggle-color: #475569;
            --delineado-color: rgba(249, 115, 22, 0.15);
            --delineado-border: rgba(249, 115, 22, 0.3);
            --tab-text: #1f2937;
            --tab-bg: #e5e7eb;
            --tab-active-bg: #f97316;
            --tab-active-text: white;
        }

        .dark-mode {
            --bg-start: #1e1e1e; 
            --bg-end: #333333;   
            --panel-bg: #2a2a2a; 
            --text-color: #f3f4f6;
            --subtitle-color: #fb923c;
            --input-bg: #3a3a3a; 
            --input-border: #525252;
            --shadow-color: rgba(0, 0, 0, 0.9);
            --header-color: #f3f4f6;
            --theme-toggle-color: #cbd5e1;
            --delineado-color: rgba(251, 146, 60, 0.5);
            --delineado-border: var(--subtitle-color);
            --tab-text: #f3f4f6;
            --tab-bg: #1f2937;
            --tab-active-bg: #fb923c;
            --tab-active-text: #1f2937;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(160deg, var(--bg-start) 0%, var(--bg-end) 100%);
            min-height: 100vh;
            color: var(--text-color);
            transition: background 0.5s, color 0.5s;
        }

        .glass-panel {
            background: var(--panel-bg);
            border: 1px solid var(--delineado-border);
            box-shadow: 0 0 0 3px var(--delineado-color), 
                        0 15px 30px -8px var(--shadow-color);
            transition: background 0.5s, box-shadow 0.5s, border-color 0.5s;
        }

        .h1-dynamic { color: var(--header-color); }
        .p-dynamic { color: var(--text-color); }
        .p-subtitle { color: var(--subtitle-color); }
        .input-bg { 
            background-color: var(--input-bg); 
            border-color: var(--input-border);
            color: var(--text-color);
            transition: background-color 0.5s, border-color 0.5s, color 0.5s;
        }
        .theme-toggle-color { color: var(--theme-toggle-color); }

        .tab-button {
            color: var(--tab-text);
            background-color: var(--tab-bg);
        }
        .tab-button.active {
            color: var(--tab-active-text);
            background-color: var(--tab-active-bg);
            box-shadow: 0 4px 10px rgba(249, 115, 22, 0.4);
        }
        .dark-mode .tab-button.active {
            box-shadow: 0 4px 10px rgba(251, 146, 60, 0.4);
        }

        .dark-mode select { color: var(--text-color) !important; }
        .dark-mode select option { background-color: #171717; color: #f3f4f6; }
        
        @keyframes shimmer {
            0% { background-position: -400px 0; }
            100% { background-position: 400px 0; }
        }

        /* Anima√ß√£o de pulso vermelho para grava√ß√£o */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-pulse {
            animation: pulse-red 1.5s infinite;
            background-color: #ef4444 !important; /* Vermelho */
            border-color: #ef4444 !important;
        }

        /* Toast de notifica√ß√£o */
        #toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: #22c55e;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
        }
        #toast-notification.show {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center">

    <!-- Toast de Notifica√ß√£o -->
    <div id="toast-notification">Texto copiado!</div>

    <div class="w-full max-w-[32rem] glass-panel p-6 sm:p-8 md:p-10 rounded-3xl my-8 relative">
        
        <!-- Bot√£o de Modo Escuro/Claro -->
        <button id="theme-toggle" class="absolute top-4 right-4 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-black/30 transition duration-300 theme-toggle-color" onclick="toggleTheme()">
            <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75v-2.25m-6.364 1.591l1.591-1.591M3 12h2.25m-.386-6.364l1.591 1.591M12 12a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5zm0 0l-1.577 1.577c.348.069.676.108 1.006.108h1.144c.33 0 .658-.039 1.006-.108l-1.577-1.577z" />
            </svg>
            <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6 hidden">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.726 9.726 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.59.748-3.75 0 0-.482-.692-.68-1.55-.178-.795-.145-1.516.29-2.007.435-.491 1.156-.524 1.951-.346.858.198 1.55.68 1.55.68A9.757 9.757 0 0118.75 3c.795 0 1.58.077 2.338.226z" />
            </svg>
        </button>

        <div class="text-center mb-10">
            <div class="relative w-36 h-36 mx-auto mb-6 group">
                <img id="profile-image" src="https://raw.githubusercontent.com/atomicgamesbrasil/Painel-Atomic/main/texto%20em%20voz.webp?v=999" onerror="this.onerror=null; this.src='https://api.dicebear.com/9.x/avataaars/svg?seed=Thiago';" alt="Thiago Castro" class="w-full h-full rounded-full object-cover shadow-xl border-4 border-white transition-transform duration-300 transform group-hover:scale-105 bg-gray-200">
            </div>
            <h1 class="text-4xl sm:text-5xl font-extrabold h1-dynamic tracking-tight">Gerador de √Åudio</h1>
            <p class="font-extrabold text-xl mt-2 p-subtitle">Thiago Castro</p>
            <p class="mt-4 p-dynamic max-w-md mx-auto text-base leading-relaxed">Ferramenta completa: Texto para Voz, Tradu√ß√£o e Transcri√ß√£o.</p>
        </div>

        <div class="flex p-1 rounded-xl shadow-inner mb-8" style="background-color: var(--input-bg);">
            <button class="flex-1 py-3 px-1 rounded-xl text-xs sm:text-sm font-bold tab-button active" onclick="showTab('tts', this)">Texto p/ √Åudio</button>
            <button class="flex-1 py-3 px-1 rounded-xl text-xs sm:text-sm font-bold tab-button" onclick="showTab('translate', this)">Tradu√ß√£o</button>
            <button class="flex-1 py-3 px-1 rounded-xl text-xs sm:text-sm font-bold tab-button" onclick="showTab('transcribe', this)">Transcrever</button>
        </div>

        <div id="tab-content" class="space-y-8">
            <!-- TTS Tab -->
            <div id="tts" class="tab-pane">
                <div class="p-2 rounded-xl border shadow-md input-bg">
                    <div class="relative">
                        <select id="voice-select" class="w-full p-4 bg-transparent font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 appearance-none cursor-pointer input-bg">
                            <option value="Orus" selected>üéôÔ∏è Orus (Masculina - Padr√£o)</option>
                            <option value="Puck">üéôÔ∏è Puck (Masculina - Suave)</option>
                            <option value="Fenrir">üéôÔ∏è Fenrir (Masculina - Grave)</option>
                            <option value="Charon">üéôÔ∏è Charon (Masculina - Jovem)</option>
                            <option value="Iapetus">üéôÔ∏è Iapetus (Masculina - Clara)</option>
                            <option value="Kore">üéôÔ∏è Kore (Feminina - Clara)</option>
                            <option value="Leda">üéôÔ∏è Leda (Feminina - Calma)</option>
                            <option value="Aoede">üéôÔ∏è Aoede (Feminina - Elegante)</option>
                        </select>
                        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none p-dynamic">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </div>
                    </div>
                </div>

                <div>
                    <label for="text-input" class="block text-xs font-bold uppercase tracking-wider mb-2 ml-1 p-dynamic">Seu Texto</label>
                    <textarea id="text-input" rows="10" class="w-full p-6 border rounded-3xl focus:ring-2 focus:ring-orange-500 focus:border-transparent resize-y transition-shadow text-base leading-relaxed shadow-lg shadow-slate-100 input-bg placeholder-gray-400" placeholder="Digite ou cole o texto aqui..." onclick="autoPasteTranscription(this)">E a√≠, galera! Eu sou o Thiago Castro!
Essa √© a minha voz padr√£o, com sotaque carioca. Use este espa√ßo para testar as varia√ß√µes de voz e gerar seus √°udios.üöÄ</textarea>
                </div>

                <button id="generate-button" class="w-full group relative bg-orange-500 hover:bg-orange-600 text-white font-bold py-5 px-6 rounded-2xl shadow-xl shadow-orange-400/50 transition-all duration-300 transform hover:-translate-y-1 active:shadow-none disabled:opacity-70 disabled:cursor-not-allowed overflow-hidden" onclick="generateFullAudio()">
                    <div class="relative z-10 flex items-center justify-center gap-3">
                        <span id="button-icon">üé§</span>
                        <span id="button-text">Gerar √Åudio Completo</span>
                        <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </div>
                </button>

                <div id="progress-container" class="hidden pt-2">
                    <div class="flex justify-between text-xs font-semibold mb-2 p-dynamic">
                        <span id="progress-text">Processando...</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden input-bg">
                        <div id="progress-bar" class="bg-orange-500 h-3 rounded-full transition-all duration-300 ease-out w-0 relative overflow-hidden"><div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div></div>
                    </div>
                </div>

                <div id="results-area" class="mt-8 hidden animate-[fadeIn_0.5s_ease-out]">
                    <div class="bg-green-100 border border-green-200 rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-green-200 p-2 rounded-full text-green-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                            <h2 class="text-xl font-bold text-green-800">Pronto, Thiago!</h2>
                        </div>
                        <div class="p-4 rounded-xl shadow-md border input-bg">
                            <audio id="audio-player" controls class="w-full accent-orange-500"></audio>
                        </div>
                        <p class="text-center text-green-700/70 text-sm mt-3 font-medium p-dynamic">Clique nos tr√™s pontinhos do player para baixar o arquivo</p>
                    </div>
                </div>
                <div id="error-message" class="hidden mt-6 bg-red-100 border border-red-300 text-red-700 p-4 rounded-xl text-sm font-medium animate-[shake_0.5s_ease-in-out] shadow-md"></div>
            </div>

            <!-- Translation Tab -->
            <div id="translate" class="tab-pane hidden">
                <div class="space-y-4">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <select id="translate-source-lang" class="flex-1 p-3 rounded-xl border input-bg">
                            <option value="pt" selected>Portugu√™s (detectado)</option>
                            <option value="en">Ingl√™s</option>
                            <option value="es">Espanhol</option>
                            <option value="fr">Franc√™s</option>
                            <option value="de">Alem√£o</option>
                            <option value="it">Italiano</option>
                            <option value="ja">Japon√™s</option>
                            <option value="ko">Coreano</option>
                            <option value="zh">Chin√™s</option>
                            <option value="ru">Russo</option>
                        </select>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 my-auto p-dynamic self-center sm:self-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                        <select id="translate-target-lang" class="flex-1 p-3 rounded-xl border input-bg">
                            <option value="en" selected>Ingl√™s (EUA)</option>
                            <option value="pt">Portugu√™s</option>
                            <option value="es">Espanhol</option>
                            <option value="fr">Franc√™s</option>
                            <option value="de">Alem√£o</option>
                            <option value="it">Italiano</option>
                            <option value="ja">Japon√™s</option>
                            <option value="ko">Coreano</option>
                            <option value="zh">Chin√™s</option>
                            <option value="ru">Russo</option>
                        </select>
                    </div>
                    <label class="block text-xs font-bold uppercase tracking-wider ml-1 p-dynamic">Texto Original</label>
                    <textarea id="translation-source-text" rows="6" class="w-full p-6 border rounded-3xl resize-y shadow-lg input-bg" placeholder="Digite o texto a ser traduzido..."></textarea>
                    <button id="translate-button" class="w-full group relative bg-orange-500 hover:bg-orange-600 text-white font-bold py-5 px-6 rounded-2xl shadow-xl shadow-orange-400/50 transition-all duration-300 transform hover:-translate-y-1" onclick="translateText()">
                        <span id="translate-button-text" class="relative z-10 flex items-center justify-center gap-2">Traduzir Agora</span>
                        <svg id="translate-loading-spinner" class="animate-spin h-5 w-5 text-white absolute inset-0 m-auto hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                    <label class="block text-xs font-bold uppercase tracking-wider ml-1 p-dynamic mt-4">Resultado</label>
                    <textarea id="translation-result-text" rows="6" class="w-full p-6 border rounded-3xl resize-y shadow-lg input-bg" readonly placeholder="A tradu√ß√£o aparecer√° aqui."></textarea>
                </div>
            </div>

            <!-- Transcription Tab (ATUALIZADA) -->
            <div id="transcribe" class="tab-pane hidden">
                <div class="space-y-4">
                    <p class="p-dynamic text-sm mb-2">Grave um √°udio ou fa√ßa upload para converter em texto.</p>
                    
                    <!-- Bot√£o de Microfone -->
                    <div class="flex flex-col items-center justify-center mb-6">
                        <button id="record-button" onclick="toggleRecording()" class="w-20 h-20 rounded-full bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 flex items-center justify-center transition-all duration-300 shadow-lg group relative">
                            <!-- √çcone Microfone (Normal) -->
                            <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-slate-600 dark:text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                            <!-- √çcone Stop (Gravando) -->
                            <svg id="stop-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                            </svg>
                        </button>
                        <span id="recording-status" class="text-xs font-bold mt-2 p-dynamic uppercase tracking-wider">Toque para Gravar</span>
                        
                        <!-- Preview do √Åudio Gravado -->
                        <div id="recorded-audio-container" class="hidden mt-4 w-full">
                            <audio id="recorded-audio-preview" controls class="w-full accent-orange-500"></audio>
                            <p class="text-center text-xs text-green-600 font-bold mt-1">√Åudio gravado com sucesso!</p>
                        </div>
                    </div>

                    <!-- Divisor -->
                    <div class="flex items-center justify-center my-4">
                        <div class="border-t border-gray-300 dark:border-gray-600 w-full"></div>
                        <span class="px-3 text-xs font-bold text-gray-400 uppercase">OU</span>
                        <div class="border-t border-gray-300 dark:border-gray-600 w-full"></div>
                    </div>
                    
                    <!-- File Input estilizado -->
                    <div class="flex items-center justify-center w-full">
                        <label for="audio-file-input" class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed rounded-2xl cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 border-gray-300 hover:border-orange-500 transition-colors input-bg">
                            <div class="flex flex-col items-center justify-center pt-2">
                                <svg class="w-6 h-6 mb-2 text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                                </svg>
                                <p class="text-xs text-gray-500 dark:text-gray-400"><span class="font-semibold">Upload de arquivo</span> (MP3, WAV)</p>
                            </div>
                            <input id="audio-file-input" type="file" class="hidden" accept="audio/*" />
                        </label>
                    </div>
                    <div id="file-name-display" class="text-xs font-bold text-center p-subtitle hidden"></div>

                    <button id="transcribe-button" class="w-full group relative bg-orange-500 hover:bg-orange-600 text-white font-bold py-5 px-6 rounded-2xl shadow-xl shadow-orange-400/50 transition-all duration-300 transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed" onclick="transcribeAudio()">
                        <span id="transcribe-button-text" class="relative z-10 flex items-center justify-center gap-2">Transcrever √Åudio</span>
                        <svg id="transcribe-loading-spinner" class="animate-spin h-5 w-5 text-white absolute inset-0 m-auto hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>

                    <label class="block text-xs font-bold uppercase tracking-wider ml-1 p-dynamic mt-4">Transcri√ß√£o (Toque para copiar)</label>
                    <textarea id="transcription-result-text" rows="8" class="w-full p-6 border rounded-3xl resize-y shadow-lg input-bg cursor-pointer hover:border-orange-400 transition-colors" readonly placeholder="O texto do √°udio aparecer√° aqui... Toque nele para copiar e usar no gerador." onclick="copyTranscriptionToClipboard(this)"></textarea>
                </div>
            </div>
        </div>

        <div id="error-message" class="hidden mt-6 bg-red-100 border border-red-300 text-red-700 p-4 rounded-xl text-sm font-medium animate-[shake_0.5s_ease-in-out] shadow-md"></div>
    </div>

    <script>
        // ---------------- CONFIGURA√á√ÉO DE SEGURAN√áA ----------------
        // PASSO 1: Primeira parte da chave
        const KEY_PREFIX = "AIza"; 
        
        // PASSO 2: Segunda parte da chave
        const PARTIAL_KEY = "SyAT3F1PV1JH5CKa1gK3roevlrW65qWdxto"; 
        
        // O app reconstr√≥i a chave automaticamente (com trim para seguran√ßa)
        const apiKey = (KEY_PREFIX + PARTIAL_KEY).trim();
        // -----------------------------------------------------------

        const ttsApiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent";
        const textApiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        // GLOBAL VARIABLE FOR SMART PASTE
        let pendingTranscription = "";

        // Valida√ß√£o simples
        function checkApiKey() {
            if (!PARTIAL_KEY || PARTIAL_KEY.length < 10) {
                alert("ERRO DE CONFIGURA√á√ÉO: Chave de API inv√°lida.");
                return false;
            }
            return true;
        }

        // --- FUN√á√ïES AUXILIARES ---
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1; const bytesPerSample = 2;
            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);
            let offset = 0;
            const writeString = (s) => { for (let i = 0; i < s.length; i++) view.setUint8(offset++, s.charCodeAt(i)); };
            const writeUint32 = (i) => { view.setUint32(offset, i, true); offset += 4; };
            const writeUint16 = (i) => { view.setUint16(offset, i, true); offset += 2; };

            writeString('RIFF'); writeUint32(36 + pcm16.length * bytesPerSample); writeString('WAVE'); writeString('fmt ');
            writeUint32(16); writeUint16(1); writeUint16(numChannels); writeUint32(sampleRate);
            writeUint32(sampleRate * numChannels * bytesPerSample); writeUint16(numChannels * bytesPerSample);
            writeUint16(bytesPerSample * 8); writeString('data'); writeUint32(pcm16.length * bytesPerSample);

            for (let i = 0; i < pcm16.length; i++) { view.setInt16(offset, pcm16[i], true); offset += 2; }
            return new Blob([view], { type: 'audio/wav' });
        }

        // --- UI NOTIFICATIONS (TOAST) ---
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- TEMA E ABAS ---
        const body = document.body;
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');

        function applyTheme(theme) {
            if (theme === 'dark') {
                body.classList.add('dark-mode');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                body.classList.remove('dark-mode');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            localStorage.setItem('theme', theme);
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            showTab('tts', document.querySelector('.tab-button'));
            
            // Listener para mostrar nome do arquivo selecionado
            const fileInput = document.getElementById('audio-file-input');
            const fileNameDisplay = document.getElementById('file-name-display');
            const recordedAudioContainer = document.getElementById('recorded-audio-container');
            const recordedAudioPreview = document.getElementById('recorded-audio-preview');

            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    fileNameDisplay.textContent = `Arquivo selecionado: ${this.files[0].name}`;
                    fileNameDisplay.classList.remove('hidden');
                    // Limpa o √°udio gravado se houver, para evitar confus√£o
                    recordedAudioBlob = null;
                    recordedAudioContainer.classList.add('hidden');
                    recordedAudioPreview.src = '';
                } else {
                    fileNameDisplay.classList.add('hidden');
                }
            });
        });
        
        function showTab(tabId, clickedButton) {
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabId).classList.remove('hidden');
            clickedButton.classList.add('active');
        }

        // --- DIVIS√ÉO INTELIGENTE DE TEXTO ---
        function splitTextIntoSentences(text) {
            const segments = text.match(/[^.?!;]+[.?!;]*|.+/g) || [];
            let chunks = [];
            let currentChunk = "";
            for (let segment of segments) {
                if ((currentChunk + segment).length < 200) {
                    currentChunk += segment;
                } else {
                    if (currentChunk.trim().length > 0) chunks.push(currentChunk);
                    currentChunk = segment;
                }
            }
            if (currentChunk.trim().length > 0) chunks.push(currentChunk);
            return chunks;
        }

        // --- TRADU√á√ÉO ---
        async function translateText() {
            if (!checkApiKey()) return;

            const sourceTextarea = document.getElementById('translation-source-text');
            const resultTextarea = document.getElementById('translation-result-text');
            const sourceLang = document.getElementById('translate-source-lang').value;
            const targetLang = document.getElementById('translate-target-lang').value;
            const translateButton = document.getElementById('translate-button');
            const translateButtonText = document.getElementById('translate-button-text');
            const translateLoadingSpinner = document.getElementById('translate-loading-spinner');

            const text = sourceTextarea.value.trim();
            if (!text) {
                sourceTextarea.classList.add('ring-2', 'ring-red-500', 'bg-red-50');
                setTimeout(() => sourceTextarea.classList.remove('ring-2', 'ring-red-500', 'bg-red-50'), 500);
                return;
            }

            translateButton.disabled = true;
            translateButtonText.classList.add('hidden');
            translateLoadingSpinner.classList.remove('hidden');
            resultTextarea.value = "Traduzindo...";

            const userQuery = `Traduza o seguinte texto do idioma com c√≥digo '${sourceLang}' para o idioma com c√≥digo '${targetLang}'. Retorne apenas o texto traduzido e nada mais. Texto: ${text}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }] };

            try {
                let response, result;
                for (let i = 0; i < 3; i++) { 
                    response = await fetch(`${textApiUrl}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) { result = await response.json(); break; }
                    if (response.status === 429) await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                    else throw new Error(`Erro API: ${response.status}`);
                }
                
                if (!result) throw new Error("Falha na conex√£o.");
                resultTextarea.value = result.candidates?.[0]?.content?.parts?.[0]?.text || "Erro ao traduzir.";

            } catch (error) {
                console.error("Erro:", error);
                resultTextarea.value = `Erro: ${error.message}`;
            } finally {
                translateButton.disabled = false;
                translateButtonText.classList.remove('hidden');
                translateLoadingSpinner.classList.add('hidden');
            }
        }

        // --- GRAVA√á√ÉO DE √ÅUDIO (MICROFONE) ---
        let mediaRecorder;
        let audioChunks = [];
        let recordedAudioBlob = null;
        let isRecording = false;

        async function toggleRecording() {
            const recordButton = document.getElementById('record-button');
            const micIcon = document.getElementById('mic-icon');
            const stopIcon = document.getElementById('stop-icon');
            const recordingStatus = document.getElementById('recording-status');
            const recordedAudioContainer = document.getElementById('recorded-audio-container');
            const recordedAudioPreview = document.getElementById('recorded-audio-preview');
            const fileInput = document.getElementById('audio-file-input');
            const fileNameDisplay = document.getElementById('file-name-display');

            if (!isRecording) {
                // INICIAR GRAVA√á√ÉO
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        recordedAudioBlob = new Blob(audioChunks, { type: 'audio/mp3' }); // Ou 'audio/wav' dependendo do suporte
                        const audioUrl = URL.createObjectURL(recordedAudioBlob);
                        recordedAudioPreview.src = audioUrl;
                        recordedAudioContainer.classList.remove('hidden');
                        
                        // Limpa qualquer arquivo selecionado via upload
                        fileInput.value = '';
                        fileNameDisplay.classList.add('hidden');
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    
                    // UI Updates
                    recordButton.classList.add('recording-pulse');
                    micIcon.classList.add('hidden');
                    stopIcon.classList.remove('hidden');
                    recordingStatus.textContent = "Gravando... Toque para Parar";
                    recordingStatus.classList.add('text-red-500');
                    recordedAudioContainer.classList.add('hidden'); // Esconde preview antigo

                } catch (error) {
                    alert("Erro ao acessar microfone: " + error.message + ". Verifique as permiss√µes do navegador.");
                    console.error(error);
                }
            } else {
                // PARAR GRAVA√á√ÉO
                mediaRecorder.stop();
                isRecording = false;

                // UI Updates
                recordButton.classList.remove('recording-pulse');
                micIcon.classList.remove('hidden');
                stopIcon.classList.add('hidden');
                recordingStatus.textContent = "Toque para Gravar";
                recordingStatus.classList.remove('text-red-500');
            }
        }

        // --- SMART COPY / PASTE LOGIC ---
        function copyTranscriptionToClipboard(element) {
            if (!element.value) return;

            // Seleciona o conte√∫do do campo
            element.select();
            element.setSelectionRange(0, 99999); // Para dispositivos m√≥veis

            try {
                // Tenta copiar usando o comando antigo (mais compat√≠vel com iFrames)
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast("Texto copiado! V√° para a aba de √°udio.");
                    
                    // Feedback visual
                    const originalBorder = element.style.borderColor;
                    element.style.borderColor = "#22c55e"; // Verde
                    element.classList.add('ring-2', 'ring-green-500');
                    
                    setTimeout(() => {
                        element.style.borderColor = originalBorder;
                        element.classList.remove('ring-2', 'ring-green-500');
                    }, 500);
                } else {
                    throw new Error("Comando de c√≥pia falhou");
                }
            } catch (err) {
                console.error('Erro ao copiar', err);
                showToast("Erro ao copiar. Tente selecionar manualmente.");
            }
        }

        function autoPasteTranscription(element) {
            // Verifica se tem algo pendente na mem√≥ria interna
            if (pendingTranscription && pendingTranscription.length > 0) {
                // Efeito visual antes de colar
                element.style.transition = "background-color 0.2s";
                element.style.backgroundColor = "#dcfce7"; // Verde claro
                
                // Cola o texto
                element.value = pendingTranscription;
                
                // Feedback
                showToast("Texto da transcri√ß√£o colado!");
                
                // Limpa a vari√°vel para n√£o colar de novo acidentalmente
                pendingTranscription = "";
                
                setTimeout(() => {
                    element.style.backgroundColor = ""; // Volta ao normal
                }, 500);
            }
        }

        // --- TRANSCRI√á√ÉO (SPEECH-TO-TEXT) ---
        async function transcribeAudio() {
            if (!checkApiKey()) return;

            const fileInput = document.getElementById('audio-file-input');
            const resultTextarea = document.getElementById('transcription-result-text');
            const transcribeButton = document.getElementById('transcribe-button');
            const transcribeButtonText = document.getElementById('transcribe-button-text');
            const transcribeLoadingSpinner = document.getElementById('transcribe-loading-spinner');

            let blobToSend = null;
            let mimeType = "audio/mp3"; // Padr√£o

            // Verifica se tem arquivo de upload ou grava√ß√£o
            if (fileInput.files && fileInput.files[0]) {
                blobToSend = fileInput.files[0];
                mimeType = blobToSend.type || "audio/mp3";
            } else if (recordedAudioBlob) {
                blobToSend = recordedAudioBlob;
                // Blob do MediaRecorder muitas vezes n√£o tem type definido corretamente no Android, for√ßamos um compat√≠vel
                mimeType = "audio/mp3"; 
            } else {
                alert("Por favor, grave um √°udio ou selecione um arquivo primeiro.");
                return;
            }

            if (blobToSend.size > 20 * 1024 * 1024) { 
                alert("O √°udio √© muito grande. Limite de 20MB.");
                return;
            }

            transcribeButton.disabled = true;
            transcribeButtonText.classList.add('hidden');
            transcribeLoadingSpinner.classList.remove('hidden');
            resultTextarea.value = "Enviando √°udio para a IA (isso pode levar alguns segundos)...";

            // Converter Blob para Base64
            const reader = new FileReader();
            reader.onload = async function(e) {
                // Pega apenas a parte base64 da string dataURL
                const base64Data = e.target.result.split(',')[1];

                const payload = {
                    contents: [{
                        parts: [
                            { text: "Transcreva o √°udio a seguir fielmente." },
                            { inlineData: { mimeType: mimeType, data: base64Data } }
                        ]
                    }]
                };

                try {
                    let response, result;
                    for (let i = 0; i < 3; i++) {
                        response = await fetch(`${textApiUrl}?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (response.ok) { result = await response.json(); break; }
                        if (response.status === 429) await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                        else throw new Error(`Erro API: ${response.status} - ${response.statusText}`);
                    }

                    if (!result) throw new Error("Falha na conex√£o com a API.");
                    
                    const transcription = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (transcription) {
                        resultTextarea.value = transcription;
                        // SALVA NA VARI√ÅVEL GLOBAL PARA O "SMART PASTE"
                        pendingTranscription = transcription;
                    } else {
                        resultTextarea.value = "A IA n√£o retornou texto. O √°udio pode estar vazio ou inaud√≠vel.";
                    }

                } catch (error) {
                    console.error("Erro na transcri√ß√£o:", error);
                    resultTextarea.value = `Erro: ${error.message}.`;
                } finally {
                    transcribeButton.disabled = false;
                    transcribeButtonText.classList.remove('hidden');
                    transcribeLoadingSpinner.classList.add('hidden');
                }
            };
            
            reader.onerror = function() {
                resultTextarea.value = "Erro ao processar o arquivo de √°udio.";
                transcribeButton.disabled = false;
                transcribeButtonText.classList.remove('hidden');
                transcribeLoadingSpinner.classList.add('hidden');
            };

            reader.readAsDataURL(blobToSend);
        }

        // --- TTS (√ÅUDIO) ---
        const textInput = document.getElementById('text-input');
        const generateButton = document.getElementById('generate-button');
        const buttonText = document.getElementById('button-text');
        const buttonIcon = document.getElementById('button-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsArea = document.getElementById('results-area');
        const audioPlayer = document.getElementById('audio-player');
        const errorMessage = document.getElementById('error-message');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressPercent = document.getElementById('progress-percent');

        async function fetchAudioChunk(textChunk, voiceName) {
            const url = `${ttsApiUrl}?key=${apiKey}`;
            const fullPrompt = `Leia em portugu√™s do Brasil, estilo carioca educado, tom informal, com ritmo ligeiramente acelerado: ${textChunk}`;
            
            const payload = {
                contents: [{ parts: [{ text: fullPrompt }] }],
                generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceName } } } },
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                ]
            };

            let response, result;
            const timeoutDuration = 20000;
            
            for (let i = 0; i < 5; i++) { 
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeoutDuration);

                    response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    if (response.ok) {
                        try { result = await response.json(); } catch (e) { await new Promise(r => setTimeout(r, 1000)); continue; }
                        
                        // Check for safety block or empty data
                        if (result.promptFeedback?.blockReason) {
                             throw new Error(`Bloqueio de seguran√ßa: ${result.promptFeedback.blockReason}`);
                        }
                        
                        if (result.candidates?.[0]?.content?.parts?.[0]?.inlineData) break;
                        await new Promise(r => setTimeout(r, 1000)); continue;
                    }
                    
                    if (response.status === 429) await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                    else throw new Error(`Erro API: ${response.status}`);

                } catch (error) {
                    // Don't retry immediately on fatal errors
                    if (error.message.includes("Bloqueio")) throw error;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                    if (i === 4) throw error; // Re-throw on last attempt
                }
            }
            
            if (!result || !result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data) {
                 // Try to provide a more specific error if available
                 if (result && result.promptFeedback) {
                     throw new Error(`Falha na gera√ß√£o: Feedback de seguran√ßa (${JSON.stringify(result.promptFeedback)})`);
                 }
                throw new Error("Falha na gera√ß√£o do √°udio. Resposta vazia da API.");
            }

            const part = result.candidates[0].content.parts[0].inlineData;
            return {
                buffer: base64ToArrayBuffer(part.data),
                sampleRate: part.mimeType.match(/rate=(\d+)/) ? parseInt(part.mimeType.match(/rate=(\d+)/)[1]) : 24000
            };
        }

        async function generateFullAudio() {
            if (!checkApiKey()) return;

            const text = textInput.value.trim();
            const selectedVoice = document.getElementById('voice-select').value;

            if (!text) {
                textInput.classList.add('ring-2', 'ring-red-500', 'bg-red-50');
                setTimeout(() => textInput.classList.remove('ring-2', 'ring-red-500', 'bg-red-50'), 500);
                return;
            }

            generateButton.disabled = true;
            buttonText.textContent = 'Gerando √Åudio...';
            buttonIcon.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            errorMessage.classList.add('hidden');
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            audioPlayer.src = '';

            try {
                const chunks = splitTextIntoSentences(text);
                const totalChunks = chunks.length;
                let allPcmData = [];
                let finalSampleRate = 24000;
                let lastError = null;

                for (let i = 0; i < totalChunks; i++) {
                    const chunkText = chunks[i];
                    const percent = Math.round(((i) / totalChunks) * 100);
                    progressBar.style.width = `${percent}%`;
                    progressPercent.textContent = `${percent}%`;
                    progressText.textContent = `Processando parte ${i + 1} de ${totalChunks}...`;

                    if (i > 0) await new Promise(r => setTimeout(r, 750));

                    try {
                        const chunkAudio = await fetchAudioChunk(chunkText, selectedVoice);
                        finalSampleRate = chunkAudio.sampleRate;
                        allPcmData.push(new Int16Array(chunkAudio.buffer));
                    } catch (err) {
                        console.warn(`Pulando trecho ${i+1}:`, err);
                        lastError = err;
                        // Se for erro de permiss√£o ou requisi√ß√£o inv√°lida, para tudo
                        if (err.message.includes("400") || err.message.includes("403") || err.message.includes("Bloqueio")) {
                            break; 
                        }
                    }
                }

                if (allPcmData.length === 0) {
                     throw new Error(lastError ? lastError.message : "Nenhum √°udio gerado. Verifique a chave de API.");
                }

                progressBar.style.width = `100%`;
                progressPercent.textContent = `100%`;
                
                const totalLength = allPcmData.reduce((acc, curr) => acc + curr.length, 0);
                const finalBuffer = new Int16Array(totalLength);
                let offset = 0;
                for (const chunk of allPcmData) {
                    finalBuffer.set(chunk, offset);
                    offset += chunk.length;
                }

                const wavBlob = pcmToWav(finalBuffer, finalSampleRate);
                audioPlayer.src = URL.createObjectURL(wavBlob);
                resultsArea.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                errorMessage.textContent = `Erro: ${error.message}`;
                errorMessage.classList.remove('hidden');
            } finally {
                generateButton.disabled = false;
                buttonText.textContent = 'Gerar √Åudio Completo';
                buttonIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                setTimeout(() => { if(!resultsArea.classList.contains('hidden')) progressContainer.classList.add('hidden'); }, 1000);
            }
        }
    </script>
</body>
</html>
